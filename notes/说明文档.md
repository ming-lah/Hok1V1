# 项目简介

## 任务介绍
通过强化学习算法训练一个智能体（模型），控制英雄单位在场景中进行移动、攻击等操作，目标是摧毁对方阵营的防御塔。率先摧毁对方防御塔的一方获得胜利。

## 场景介绍

墨家机关道地图


## 元素介绍
本地图由多个关键元素组成，这些元素共同构成了游戏的核心玩法和战略布局。每个元素在地图中的位置和功能都至关重要，以下表格详细介绍了这些主要元素及其作用：

| 元素名称     | 描述                                                                 |
|--------------|----------------------------------------------------------------------|
| 英雄         | 任务中智能体控制的英雄单位。                                         |
| 复活点       | 地图两端，分别为红蓝双方智能体（英雄单位）的复活位置。英雄在被击败后会从此处重新进入战斗。 |
| 水晶         | 位于复活点前方，是己方阵营的核心建筑。水晶周期性生成己方小兵，支持持续推进和防守。 |
| 小兵         | 自动沿地图中间的道路向敌方阵营推进，遇敌时会自动攻击敌方小兵、防御塔和英雄单位，承担前线作战任务。 |
| 防御塔       | 布置在水晶前方，具备自动攻击进入其攻击范围内的敌方英雄和小兵的能力，是保护水晶的重要防御设施。 |
| 英雄技能     | 每个英雄独有的能力，包括被动和主动技能。技能决定了英雄在游戏中的表现和作用，比如输出伤害、控制敌人、辅助队友或增强自身属性。 |
| 召唤师技能   | 英雄的额外辅助技能，能够在战斗中提供位移、治疗、加速等多种战术支持。 |

## 英雄信息
本环境中智能体能控制的英雄单位为孙尚香。

**孙尚香**
- 英雄技能

| 技能名称     | 技能ID | 技能描述                                                                 |
|--------------|--------|--------------------------------------------------------------------------|
| 被动技能: 活力迸发 | 11100  | 孙尚香每次普攻命中敌人可减少0.5秒【翻滚突袭】的冷却。                     |
| 一技能: 翻滚突袭   | 11110  | 翻滚向指定方向，并使下次普攻增加射程并具有穿透效果。翻滚后附近存在敌方英雄增加自身移动速度。 |
| 二技能: 红莲爆弹   | 11120  | 向指定区域投掷手雷，对命中敌人造成伤害并标记，技能命中减少敌人10%物理防御，孙尚香的普攻对标记目标造成额外伤害。 |
| 三技能: 究极弩炮   | 11130  | 向指定方向发射炮弹，接触敌人或达到最远射程发生爆炸，造成范围伤害。       |

- 召唤师技能

| 技能名称 | 技能ID | 技能描述                           |
|----------|--------|------------------------------------|
| 闪现     | 80115  | 120秒CD：向指定方向位移一段距离。 |

更多信息可前往王者荣耀官网或王者荣耀游戏中了解。

# 环境详述

## 环境配置

在智能体和环境的交互中，首先会调用`env.reset`方法，该方法接受一个`usr_conf`参数，这个参数通过读取`agent_算法名/conf/train_env_conf.toml`文件的内容来实现定制化的环境配置。因此，用户可以通过修改`train_env_conf.toml`文件中的内容来调整环境配置。

```python
# usr_conf为代码包中的train_env_conf.toml配置文件，此处以agent_ppo为例
usr_conf = read_usr_conf("agent_ppo/conf/train_env_conf.toml", logger)
observation, extra_info = env.reset(usr_conf=usr_conf)
```

`train_env_conf.toml`中包含以下信息：

| 配置标签                     | 支持字段                     | 字段描述                                                                 |
|------------------------------|------------------------------|--------------------------------------------------------------------------|
| monitor                      | monitor_side                 | 监控上报的阵营，统计指标以该阵营为第一视角。类型为整型，取值范围为 [0,1]，其中 0 表示蓝方阵营，1 表示红方阵营。 |
|                              | auto_switch_monitor_side     | 是否启用自动换边逻辑，类型为布尔值。true 表示开启，false 表示关闭。       |
| episode                      | opponent_agent               | 训练时选择的对手智能体类型。取值范围[selfplay, common_ai, 自定义模型 id]。1. selfplay 表示自对弈 2. common_ai 表示对战基于规则的 common_ai，能力略弱于普通玩家。3. 自定义的模型id：与指定的模型对战，需要先将模型上传至模型管理，并且将模型ID配置在kaiwu.json中，然后在此处进行引用。 |
|                              | eval_interval                | 评估间隔(单位局)，取值范围为大于等于 1 的整数。                          |
|                              | eval_opponent_type           | 训练时评估模式中，评估对局选择的对手智能体类型。取值范围为[selfplay, common_ai, 自定义模型 id]。 |
| lineups.blue_camp            | hero_id                     | 英雄ID                                                                  |
| lineups.red_camp             | hero_id                     | 英雄ID                                                                  |

具体使用方式请参考下方提供的默认示例

```python
[monitor]
# 监控上报的阵营，类型整型，取值范围[0,1]
# 0表示蓝方阵营，1表示红方阵营
monitor_side = 0  

# Auto switch monitor side, Type: boolean, value range: [true, false]
# 是否启用自动换边逻辑，类型布尔值，true表示开启，false表示关闭
auto_switch_monitor_side = true

[episode]
# 对手智能体，类型字符串，取值范围[selfplay, common_ai, 自定义模型id]
# 1. selfplay：自对弈
# 2. common_ai：与基于规则的common_ai对战
# 3. 自定义的模型id：与指定的模型对战，需要先将模型上传至模型管理，并且将模型ID配置在kaiwu.json中，然后在此处进行引用
opponent_agent = "selfplay"

# 评估间隔(单位局)，类型整型，取值范围为大于等于1的整数
eval_interval = 10

# 评估对手类型，类型字符串，取值范围为[selfplay, common_ai, 自定义模型id]
# 值的含义请参考opponent_agent注释
eval_opponent_type = "common_ai"

# 蓝方阵容配置
[[lineups.blue_camp]]
# 英雄ID，类型整数，取值范围: 111 孙尚香
hero_id = 111

# 红方阵容配置
[[lineups.red_camp]]
# 英雄ID，类型整数，取值范围: 111 孙尚香
hero_id = 111
```

💡 补充说明：

- train_env_conf.toml文件中的配置仅在训练时生效，请按上表数据描述进行配置。若配置错误，训练任务会变为“失败”状态，此时可以通过查看env模块的错误日志进行排查。
- 若需调整模型评估任务时的配置，用户需要通过腾讯开悟平台创建评估任务并完成环境配置，详细参数见智能体模型评估模式。

## 环境信息

调用`env.step`接口时，会返回环境当前的观测数据：

| 数据名       | 数据类型    | 数据描述                                           |
|--------------|-------------|----------------------------------------------------|
| frame_no     | int32       | 当前环境实例运行时的帧数                           |
| observation  | Observation | 环境实例针对智能体提供的观测信息                   |
| terminated   | int32       | 当前环境实例是否结束                               |
| truncated    | int32       | 当前环境实例是否异常或中断                         |
| extra_info   | ExtraInfo   | 环境实例的可选额外信息                             |

调用 `env.reset` 可以重置环境，此时只返回上述观测数据中的 `observation` 和 `extra_info`。

下面会对这些数据进行介绍，完整的观测数据结构可以参考数据协议。

### 观测信息（observation）


`observation` 是环境实例针对智能体返回的原始信息，按照阵营进行区分。`observation[agent_id]` 的具体描述如下：

| 数据名           | 数据描述                                                                 |
|------------------|--------------------------------------------------------------------------|
| env_id           | 对局ID                                                                  |
| player_id        | 英雄运行时ID，作为英雄的唯一标识                                         |
| player_camp      | 英雄所属阵营                                                             |
| legal_action     | 合法动作                                                                 |
| sub_action_mask  | 不同动作（button）对应的合法子动作（move、skill、target）                |
| frame_state      | 环境帧状态                                                               |
| win              | 是否获胜                                                                 |

环境帧状态（frame_state）
| 数据名           | 数据描述                                                                 |
|------------------|--------------------------------------------------------------------------|
| frameNo          | 当前帧号                                                                 |
| hero_states      | 当前帧中所有英雄状态构成的集合                                           |
| npc_states       | 当前帧中所有NPC状态构成的集合（野怪、小兵、防御塔等）                   |
| frame_action     | 死亡事件构成的集合                                                       |
| map_state        | 地图状态（暂未开放）                                                     |

### 额外信息（extra_info）
环境会提供部分额外信息，训练时作为提供给智能体的观测信息的补充，评估时无法获取。在本环境中，额外信息仅包含环境的错误码和错误信息，因此不会在训练和评估时传输给智能体使用。

### 动作空间
王者1v1强化项目使用层次化的动作空间，将所有动作分为以下几类：
- **what**：你要按哪个按键（12个button）
- **how**：你要往哪个方向拖动按键（16×16个方向选择）
- **who**：你的技能作用对象是谁（9个target：None、敌方英雄、自身英雄、防御塔、4个小兵、1个野怪）

动作空间各维度说明
| Action Class     | Type               | Description                             | Dimension |
|------------------|--------------------|-----------------------------------------|-----------|
| Button           | None               | 非法动作                                | 1         |
|                  | None               | 无动作                                  | 1         |
|                  | Move               | 移动                                    | 1         |
|                  | Normal Attack      | 释放普通攻击                            | 1         |
|                  | Skill 1            | 释放第1个技能                           | 1         |
|                  | Skill 2            | 释放第2个技能                           | 1         |
|                  | Skill 3            | 释放第3个技能                           | 1         |
|                  | Heal Skill         | 释放恢复技能                            | 1         |
|                  | Chosen Skill       | 释放召唤师技能                          | 1         |
|                  | Recall             | 释放回城技能                            | 1         |
|                  | Skill 4            | 释放第4个技能（仅特定英雄有效）         | 1         |
|                  | Equipment Skill    | 释放特定装备提供的技能                  | 1         |
| Move             | Move X             | 沿X轴移动方向                           | 16        |
|                  | Move Z             | 沿Z轴移动方向                           | 16        |
| Skill            | Skill X            | 技能沿X轴方向                           | 16        |
|                  | Skill Z            | 技能沿Z轴方向                           | 16        |
| Target           | None               | 空目标                                  | 1         |
|                  | Enemy              | 敌方英雄                                | 1         |
|                  | Self               | 自身英雄                                | 1         |
|                  | Soldier            | 最近的四个小兵                          | 4         |
|                  | Tower              | 最近的防御塔                            | 1         |
|                  | Monster            | 最近的野怪                              | 1         |

Action Mask 机制
**Sub Action Mask** 对应 `observation[agent_id]["sub_action_mask"]`：

该机制根据当前按钮（button）类型，对剩余动作（action）进行选择性过滤。

原因：并非所有技能都需要拖动按键，也并非所有技能都有目标（target）。

以貂蝉为例:
- 其1技能和2技能是方向性技能，因此当预测按钮为 `skill1` 或 `skill2` 时，`skill X` 与 `skill Z` 的预测结果是有意义的。
- 而对于貂蝉的3技能，`skill X` 与 `skill Z` 的预测结果没有意义，应予以过滤。

**Legal Action Mask** 对应 `observation[agent_id]["legal_action"]`：

- 根据游戏规则，直接屏蔽不合法或不可执行的动作预测。例如：处于冷却状态（CD）中的技能无法释放，因此对应动作会被屏蔽，该机制能够加快训练速度，避免模型进行无意义的动作探索，提高训练效率。

#### Action 具体执行流程
AI 选取 action 的流程如下：
1. **选择执行的动作类型（which_button）**：
   - 从 `which_button` 维度中，选取值最大的索引对应的合法动作（legal action），作为英雄下一步要执行的动作。
2. **根据所选动作类型，确定动作参数的计算方式**：

动作参数的计算根据技能类型分为以下几类：
    1. **方向型技能**：需要读取位置偏置 `offset_x`, `offset_z` 和 `target`
    2. **位置型技能**：需要读取位置偏置 `offset_x`, `offset_z` 和 `target`
    3. **目标性技能**：只需读取 `target`

#### 示例：方向型技能的执行过程
- 橙色方块为主英雄（main_hero）的位置，黄色方块为选中的 `target` 的位置。
- 以 `target` 位置作为 `offset` 坐标系的中心点，因此它在 `offset` 维度对应的索引为 `(21, 21)`。
- 根据 `offset_x`, `offset_z` 找到最终位置（例如 `offset_x=25`, `offset_z=15`），绿色方块即为以黄色点为中心，`offset` 为 `(25, 15)` 的最终目标位置。
- 连接橙色英雄位置和绿色方块位置的红色箭头方向即为实际技能释放方向。
- **备注**：
  - 如果直接把 `(skill_x, skill_z)` 设置为 `(21, 21)`，技能的释放方向就是目标所在的位置。
  - 示例中的 `offset_x` 和 `offset_z` 是 `42×42`，但在1v1环境中，应为 `16×16`。
  - `move_x` 和 `move_z` 同理，当 action 为 `move` 时，以自身为 `target`。

### 观测视野范围
环境存在战争迷雾机制，智能体只能观测到：
- 属于己方阵营的单位；
- 处于己方阵营单位视野范围内的敌方单位和建筑。
视野范围由单位的视野半径决定，超出视野范围的敌方单位和建筑将不可见。

### 时间信息
帧（frame）和步（step）存在一定映射关系：
- **帧（frame）**：场景的一个时间单位，表示场景的一个完整更新周期。在每一帧中，场景的所有元素（如英雄状态等）都会根据当前状态和输入进行更新。
- **步（step）**：强化学习环境中的一个时间单位，表示智能体在环境中执行一个动作并接收反馈的过程。在每一步中，智能体选择一个动作，环境根据该动作更新状态，并返回新的状态、奖励和终止信号。
- 在本环境中，**1 个 step 由 6 个 frame 组成**。这意味着每个动作对应一个步，在每一步中，智能体将在六个连续的帧中执行同一个动作。环境将在每一步结束后更新状态并返回反馈，场景只有在完成六帧后，环境状态才会返回一次状态的更新。

### 时间关系
- **帧更新**：在一步中，场景进行六次帧更新，更新所有场景中对象的状态并渲染新的画面。
- **步更新**：在每一步中，智能体选择一个动作，环境更新状态并返回。
- **时间换算**：
  - 1 frame 约等于 33 ms
  - 1 step 执行 6 frame
  - 1 s 等于 1000 ms

## 环境监控信息
监控面板中包含 `env` 模块，表示环境指标数据，详细说明如下：

| 指标名称           | 说明                                                                 |
|--------------------|----------------------------------------------------------------------|
| win_rate           | 每局游戏结束，在 `monitor_side` 视角下获得游戏胜利即为 1，游戏失败为 0，游戏超时为 0.5 |
| tower_hp           | 包含两个指标：<br>- `self_tower_hp`：每局游戏结束时，`monitor_side` 阵营防御塔剩余血量<br>- `enemy_tower_hp`：每局游戏结束时，`monitor_side` 敌对阵营防御塔剩余血量 |
| frame              | 每局游戏结束时，该局游戏的总帧数                                     |
| money_per_frame    | 每局游戏结束时，在 `monitor_side` 视角获得 `money` 的总量除以对局总帧数 |
| K/D                | 包含两个指标：<br>- `kill`：单局内我方英雄击杀敌方英雄的计数<br>- `death`：单局内我方英雄被击杀的计数 |
| hurt_per_frame     | 包含两个指标：<br>- `hurt_by_hero`：每局游戏结束时，在 `monitor_side` 视角受到来自敌方英雄伤害的总量除以对局总帧数<br>- `hurt_to_hero`：每局游戏结束时，在 `monitor_side` 视角对敌方英雄造成伤害的总量除以对局总帧数 |


## 智能体详述
我们在代码包中提供了智能体的简单实现，本文将对该部分内容进行讲解，包括观测处理及优化指南等。

### 观测处理
环境返回的 `observation` 信息包含了针对智能体的局部观测信息，可以在 `observation_process` 函数中对这些局部观测信息进行处理。

很多情况下，观测信息体量较大且步骤繁多，我们推荐用户基于代码包提供的 `process_feature` 进行特征处理：

```python
def process_feature(self, observation):
    frame_state = observation["frame_state"]

    organ_feature = self.process_organ_feature(frame_state)
    main_camp_hero_vector_feature = self.process_hero_feature(frame_state)

    feature = main_camp_hero_vector_feature + organ_feature

    return feature
```

### 特征处理
通过在程序中调用 `env.reset` 或 `env.step`，环境会返回当前帧的环境状态数据，从中可以获取到英雄血量、技能信息、防御塔信息等数值，基于游戏状态数据，可以处理得到智能体网络推理所需的特征。

#### 特征区间及其维度
| 特征区间名                     | 特征维数 | 举例                     |
|--------------------------------|----------|--------------------------|
| main_camp_hero_vector_feature | 3        | 英雄存活情况、位置       |
| organ_feature                  | 7        | 敌方防御塔血量、位置     |

代码包中提供了一些特征的实现，可以参考 `<agent_算法名称>/feature/feature_process/__init__.py` 目录下的 `FeatureProcess` 类的设计和实现。`FeatureProcess` 类内部包含了 `HeroProcess`、`OrganProcess` 等子类，分别用于处理不同单位的特征。

处理特征时，首先会根据当前观测的环境帧数据来保存各个单位的信息，然后从 `feature_config` 特征配置中读取对应的特征处理函数和特征归一化配置：
- **特征处理函数**：用于从帧数据中提取特征。
- **特征归一化配置**：通过 one-hot 编码或最大最小值归一化方法，将特征归一化到 0～1 的范围，以便于网络推理计算。

注意事项：
- **位置特征**：考虑到王者1v1中地图相对于游戏双方而言是镜像对称的，在双方眼中其都处于地图左下角，故使用相对位置特征，将处于地图右上角的英雄的特征数据进行镜像反转，将其转换为左下角位置。

#### 奖励处理
这里的奖励特指强化学习中的 `Reward`，注意要与环境反馈的 `Score` 进行区分。`Score` 用于衡量玩家在任务中的表现，也作为衡量强化学习训练后的模型的优劣。

代码包里提供了一些奖励的实现，可以参考 `<agent_算法名称>/feature/reward_process.py` 里的 `GameRewardManager` 类的设计和实现，用户还可以在这个函数中去实现自己的 `reward` 设计，这部分非常开放，回报设计的依据不一定只是环境给出的信息，也可以是用户对问题的理解、经验或者知识，建议用户根据对问题和强化学习算法的理解，去设计和实现自己的 `reward`。

参考代码包中 `GameRewardManager` 对 `reward` 的实现，同学们可以通过设计多个奖励子项来帮助智能体获得更好的效果。以下是推荐设计的奖励子项：

| reward            | 存储类型 | 描述                     |
|-------------------|----------|--------------------------|
| hp_point          | dense    | 英雄生命值比例           |
| tower_hp_point    | dense    | 防御塔生命值比例         |
| money (gold)      | dense    | 获得的总金币数           |
| ep_rate           | dense    | 法力值比例               |
| death             | sparse   | 英雄被击杀               |
| kill              | sparse   | 击杀敌方英雄             |
| exp               | dense    | 获得的经验值             |
| last_hit          | sparse   | 对小兵的最后一击         |
| forward           | dense    | 前进奖励                 |

其中`tower_hp_point` 和 `forward` 奖励已在默认代码中实现，大家可以参考其设计思路进行扩展。

回报计算方法：

部分奖励使用零和 `reward` 设计方案，以当前决策帧和上一决策帧的相关数值差作为 `agent` 的 `reward`，两个 `agent` 的同类 `reward` 项相减作为最终 `reward`，最终多种 `reward` 项加权求和作为最终的 `reward` 返回。回报计算方法不止一种，我们鼓励用户进行创新。

### 算法介绍
我们在王者1v1代码包中提供了1个核心算法 **PPO**，同时，我们还提供了一个 `diy` 模板算法文件夹，用户可在该文件夹中自定义算法实现。

#### PPO 算法
PPO 算法是一种通过截断策略更新幅度平衡训练效率与稳定性的强化学习算法，核心思想是“小步多次更新，避免策略崩溃”。

### 算法监控信息
| 指标名称       | 说明                                                                 |
|----------------|----------------------------------------------------------------------|
| reward         | 对局的累积回报，反映了智能体的能力，正常训练情况下指标应该是震荡向上。 |
| total_loss     | 算法计算的所有 `loss` 总和。                                         |
| value_loss     | 算法计算的值函数的 `loss`。                                          |
| policy_loss    | 算法计算的决策动作概率的 `loss`。                                    |
| entropy_loss   | 策略的概率分布计算得到的熵 `loss`。                                  |

### 模型保存限制策略
为了避免用户保存模型的频率过于频繁，开悟平台对模型保存会有安全限制，不同的任务会有不同的限制，限制规则详情如下：
- **保存模型的频率限制**：2次/分钟
- **单个任务保存模型的次数限制**：400次

### 模型评估模式
评估时用户需要在提交任务界面进行配置，包括选择的对手模型、评估局数。另外，训练模式时，用户一般使用 `agent.predict` 方法进行决策；而在评估模式时，平台会调用 `agent.exploit` 方法进行决策，一般情况下，模型在训练和评估时的决策会因算法不同和用户设计不同，而有不同的行为，这部分由用户定义和实现。

评估时将会分别启动两个智能体容器作为 AI 服务，这个服务只有两个接口：
- **agent.reset**：输入为环境 `env.reset` 返回的 `observation`，仅在每局环境 `reset` 时调用一次。
- **agent.exploit**：输入为环境 `env.step` 返回的 `observation`，输出作为环境下一个 `env.step` 的输入。

评估的 workflow 会分别调用两个智能体的 `agent.exploit` 方法进行对战，最后根据智能体胜负情况进行模型能力的判定。

### 训练中评估模式
我们支持在训练过程中以一定的局数间隔与 `common_ai` 或用户指定的对手模型进行对战评估，以反映当前训练模型对对战水平的提升。用户需要在 `usr_conf` 中设置 `monitor_side` 作为被评估对象，另一个智能体作为评估的对手，训练时评估的数据将会在监控中展示。

#### 评估时的对手模型
- **common_ai**：这是内置在环境中的一个由规则实现的 AI，其能力是固定的。
- **用户自定义模型**：用户可以将期望用作对手模型的模型 ID 配置在 `kaiwu.json` 中（模型 ID 可以在平台的模型管理中查看），通过 `agent.load_opponent_agent()` 加载期望的模型。我们最多支持配置 3 个模型，但在一次训练中，建议只选择其中一个模型作为评估的对手。

#### kaiwu.json 配置示例
```json
{
    "model_pool": [609, 608]
}
```

**注意**：如果选择使用对手模型，那对手模型只能是当前兼容版本的模型，如果版本存在变更导致不兼容性问题，强行使用会导致加载模型失败的报错。

## 数据协议

### FrameState - 原始帧状态信息
| 字段名        | 字段类型             | 备注                                         |
|---------------|----------------------|----------------------------------------------|
| frameNo       | signed int           | 帧号                                         |
| hero_states   | vector, HeroState    | 英雄状态列表                                 |
| npc_states    | vector, ActorState   | 非英雄角色状态列表                           |
| bullets       | vector, Bullet       | 子弹列表                                     |
| cakes         | vector, Cake         | 功能物件列表（血包等）                       |
| equip_infos   | vector, EquipInfo    | 装备信息列表                                 |
| frame_action  | vector, FrameAction  | 死亡事件                                     |
| map_state     | bool                 | 大乱斗地图坍塌状态，false未坍塌，true已坍塌 |

### HeroState - 英雄属性
| 字段名               | 字段类型                     | 备注                          |
|----------------------|------------------------------|-------------------------------|
| player_id            | signed int                   | 玩家ID                        |
| actor_state          | ActorState                   | 角色状态                      |
| skill_state          | SkillState                   | 技能状态                      |
| equip_state          | EquipState                   | 装备状态                      |
| buff_state           | BuffState                    | BUFF状态                      |
| level                | signed int                   | 等级                          |
| exp                  | signed int                   | 经验                          |
| money                | signed int                   | 金钱                          |
| revive_time          | signed int                   | 复活时间                      |
| killCnt              | signed int                   | 击杀次数                      |
| deadCnt              | signed int                   | 死亡次数                      |
| assistCnt            | signed int                   | 助攻次数                      |
| moneyCnt             | signed int                   | 经济总量                      |
| totalHurt            | signed int                   | 总输出                        |
| totalHurtToHero      | signed int                   | 对英雄伤害输出                |
| totalBeHurtByHero    | signed int                   | 承受英雄伤害                  |
| passive_skill        | vector, PassiveSkill         | 被动技能                      |
| real_cmd             | vector, CmdPkg               | 实际执行指令                  |
| takeHurtInfos        | vector, TakeHurtInfo         | 承受伤害序列                  |
| canAbortCurSkill     | bool                         | 是否可以打断当前技能           |
| returnCityAbortInfo  | vector, ReturnCityAbortInfo  | 打断当前技能信息              |
| isInGrass            | bool                         | 判断英雄是否在草丛中          |
| protectInfo          | vector, ProtectInfo          | 护盾信息                      |
| canBuyEquip          | bool                         | 是否可以购买装备              |

### ActorState - 角色状态
| 字段名            | 字段类型               | 备注                                                                 |
|-------------------|------------------------|----------------------------------------------------------------------|
| config_id         | signed int             | 区分英雄                                                             |
| runtime_id        | signed int             | 运行实例ID                                                           |
| actor_type        | ActorType              | Actor主类型                                                          |
| sub_type          | ActorSubType           | Actor子类型                                                          |
| camp              | enum, COM_PLAYERCAMP   | 所属阵营：区分红蓝方                                                 |
| behav_mode        | enum, ObjBehaviMode    | 角色当前行为状态（比如死亡等）                                       |
| location          | VInt3                  | 位置                                                                 |
| forward           | VInt3                  | 朝向                                                                 |
| hp                | signed int             | 当前血量                                                             |
| max_hp            | signed int             | 最大血量                                                             |
| values            | ActorValue             | 英雄属性                                                             |
| abilities         | bool                   | 能力状态                                                             |
| attack_range      | signed int             | 攻击范围                                                             |
| attack_target     | signed int             | 攻击目标                                                             |
| kill_income       | signed int             | 含金值                                                               |
| hit_target_info   | vector, HitTargetInfo  | 命中的目标                                                           |
| camp_visible      | vector, bool           | 可见阵营，camp_visible[0]表示是否蓝方可见，camp_visible[1]表示是否红方可见 |
| sight_area        | signed int             | 视野                                                                 |
| buff_state        | ActorBuffState         | Buff状态                                                             |
| hurt_hero_state   | HurtHeroInfo           | 对英雄的伤害                                                         |

### ActorValue - 英雄属性
| 字段名            | 字段类型   | 备注            |
|-------------------|------------|-----------------|
| phy_atk           | signed int | 物理攻击        |
| phy_def           | signed int | 物理防御        |
| mgc_atk           | signed int | 魔法攻击        |
| mgc_def           | signed int | 魔法防御        |
| mov_spd           | signed int | 移动速度        |
| atk_spd           | signed int | 攻速加成        |
| ep                | signed int | 当前能量        |
| max_ep            | signed int | 最大能量        |
| hp_recover        | signed int | 生命回复        |
| ep_recover        | signed int | 能量回复        |
| phy_armor_hurt    | signed int | 物理护甲穿透    |
| mgc_armor_hurt    | signed int | 魔法护甲穿透    |
| crit_rate         | signed int | 爆击率          |
| crit_effe         | signed int | 爆击效果        |
| phy_vamp          | signed int | 物理吸血        |
| mgc_vamp          | signed int | 魔法吸血        |
| cd_reduce         | signed int | 冷却缩减        |
| ctrl_reduce       | signed int | 韧性            |

### SkillState - 技能状态
| 字段名        | 字段类型               | 备注         |
|---------------|------------------------|--------------|
| slot_states   | vector, SkillSlotState | 技能槽       |

### SkillSlotState - 技能槽状态
| 字段名             | 字段类型             | 备注                    |
|--------------------|----------------------|-------------------------|
| configId           | signed int           | 配置ID                  |
| slot_type          | SkillSlotType        | 技能槽                  |
| level              | signed int           | 等级                    |
| usable             | bool                 | 能否使用                |
| cooldown           | signed int           | CD剩余时长              |
| cooldown_max       | signed int           | CD总长                  |
| usedTimes          | signed int           | 释放次数                |
| hitHeroTimes       | signed int           | 命中英雄释放次数        |
| succUsedInFrame    | signed int           | 当前帧成功使用次数      |
| nextConfigID       | signed int           | 多段技能的下一个技能ID   |
| comboEffectTime    | signed int           | 组合技激活余留时间      |

### EquipState - 装备列表
| 字段名   | 字段类型           | 备注         |
|----------|--------------------|--------------|
| equips   | vector, EquipSlot  | 装备列表     |

### EquipSlot - 装备槽
| 字段名         | 字段类型             | 备注                     |
|----------------|----------------------|--------------------------|
| configId       | signed int           | 配置ID（对应装备配置表） |
| buyPrice       | signed int           | 购买单价                 |
| amount         | signed int           | 数量                     |
| active_skill   | vector, ActiveSkill  | 主动技能                 |
| passive_skill  | vector, PassiveSkill | 被动技能                 |

### BuffState - BUFF状态
| 字段名        | 字段类型               | 备注            |
|---------------|------------------------|-----------------|
| buff_skills   | vector, BuffSkillState | 产生的BUFF组    |
| buff_marks    | vector, BuffMarkState  | 印记状态组      |

### BuffMarkState - 印记状态
| 字段名          | 字段类型   | 备注         |
|-----------------|------------|--------------|
| origin_actorId  | signed int | 施放者ID     |
| configId        | signed int | 配置ID       |
| layer           | signed int | 层数         |

### BuffSkillState - BUFF技能状态
| 字段名      | 字段类型   | 备注         |
|-------------|------------|--------------|
| configId    | signed int | 配置ID       |
| startTime   | uint64     | 开始时间     |
| times       | signed int | 生效次数     |
| effectType  | signed int | 类型         |

### CmdPkg - 指令信息
| 字段名             | 字段类型           | 备注                      |
|--------------------|--------------------|---------------------------|
| command_type       | enum, CommandType  | 指令类型                  |
| prm_move_pos       | PrmMovePos         | 指向目标移动命令参数      |
| prm_move_dir       | PrmMoveDir         | 指向方向移动命令参数      |
| prm_attack_common  | PrmAttackCommon    | 普通攻击命令参数          |
| prm_attack_topos   | PrmAttackToPos     | 移动施法命令参数          |
| prm_attack_actor   | PrmAttackActor     | 锁定目标命令参数          |
| prm_obj_skill      | PrmObjSkill        | 目标性技能命令参数        |
| prm_dir_skill      | PrmDirSkill        | 方向性技能命令参数        |
| prm_pos_skill      | PrmPosSkill        | 位置性技能命令参数        |
| prm_learn_skill    | PrmLearnSkill      |



### PrmMovePos - 指向目标移动
| 字段名   | 类型        | 备注       |
|----------|------------|------------|
| destPos  | VInt3       | 目标位置    |

### VInt3
| 字段名 | 类型        | 备注   |
|--------|------------|--------|
| x      | signed int | x坐标   |
| y      | signed int | y坐标   |
| z      | signed int | z坐标   |

### PrmMoveDir-指定方向移动
| 字段名   | 类型  | 备注     |
|----------|-------|----------|
| degree   | int   | 角度      |
| seq      | int   | 序号      |


### PrmAttackCommon-普通攻击命令参数
| 字段名   | 类型  | 备注                   |
|----------|-------|------------------------|
| start    | int   | 0按下, 1抬起            |
| actorID  | int   | 目标actor的runtime id   |

### PrmAttackToPos-移动施法命令参数
| 字段名   | 类型  | 备注       |
|----------|-------|------------|
| destPos  | VInt3 | 目标位置    |

### PrmAttackActor-锁定目标命令参数
| 字段名   | 类型  | 备注                   |
|----------|-------|------------------------|
| actorID  | int   | 目标actor的runtime id   |

### PrmObjSkill-目标性技能命令参数
| 字段名   | 类型           | 备注          |
|----------|----------------|---------------|
| actorID  | int            | 目标actor的runtime id |
| skillID  | int            | 技能ID         |
| slotType | SkillSlotType  | 技能槽         |
| degree   | int            | 施法角度       |
| destPos  | VInt3          | 目标位置       |



### PrmLearnSkill-学习技能
| 字段名   | 类型           | 备注           |
|----------|----------------|----------------|
| slotType | SkillSlotType  | 目标技能槽      |
| level    | int            | 目标技能等级    |

### PrmBuyEquip-购买装备
| 字段名   | 类型   | 备注            |
|----------|--------|-----------------|
| equipId  | int    | 装备id          |
| obj_id   | int    | 英雄runtime id  |

### PrmSellEquip-出售装备
| 字段名      | 类型   | 备注       |
|-------------|--------|------------|
| equipIndex   | int    | 装备槽位    |



### ProtectInfo-护盾信息
| 字段名       | 类型          | 备注        |
|---------------|---------------|------------|
| protectType    | ProtectType   | 护盾类型     |
| protectValue   | unsigned int32| 护盾值       |

### HitTargetInfo-命中目标信息
| 字段名       | 类型          | 备注                  |
|---------------|---------------|------------------------|
| hit_target     | signed int    | 命中目标的runtime_id    |
| skill_id       | signed int    | 技能ID                |
| slot_type      | SkillSlotType | 施放技能槽            |


### ActorBuffState
| 字段名       | 类型                       | 备注         |
|---------------|----------------------------|--------------|
| buff_skills    | vector<BuffSkillState>     | 产生的BUFF组   |
| buff_marks     | vector<BuffMarkState>      | 印记状态组     |

### Bullet -子弹信息
| 字段名       | 类型           | 备注                     |
|----------------|----------------|---------------------------|
| runtime_id      | signed int      | 运行时id                  |
| camp            | COM_PLAYERCAMP  | 所属阵营                  |
| source_actor    | signed int      | 源actorID                 |
| slot_type       | SkillSlotType   | 施放技能槽                |
| skill_id        | signed int      | 所属技能                  |
| location        | VInt3           | 当前位置                  |
| action          | string          | 子弹AGE                   |
| born_pos        | VInt3           | 生成位置                  |
| use_dir         | VInt3           | 使用方向                  |
| use_frame       | uint32          | 使用帧号                  |
| sight_range     | signed int      | 视野范围                  |
| target_actor    | signed int      | 目标actorID               |
| size            | VInt3           | 碰撞物大小（box类型）      |

### Cake-功能物件
| 字段名      | 类型             | 备注              |
|---------------|------------------|-------------------|
| configId       | signed int        | 配置ID(神符配置表) |
| collider       | SphereCollider    | 碰撞体            |

### EquipInfo-装备信息
| 字段名       | 类型         | 备注         |
|---------------|--------------|--------------|
| equip_id       | signed int    | 装备ID        |
| equip_price    | signed int    | 装备价格      |
| equip_atoms    | signed int    | 子装备ID      |

### FrameAction-帧状态
| 字段名        | 类型           | 备注      |
|----------------|----------------|-----------|
| dead_action     | DeadAction     | 死亡事件   |

### DeadAction-死亡事件
| 字段名         | 类型             | 备注       |
|----------------|------------------|------------|
| death          | ActionActorInfo   | 死亡对象    |
| killer         | ActionActorInfo   | 击杀者      |
| assist_set     | ActionActorInfo   | 助攻者      |


### ActorType-Actor主类型
| 类型名             | 说明     |
|--------------------|----------|
| ACTOR_TYPE_HERO     | 英雄     |
| ACTOR_TYPE_MONSTER  | 野怪     |
| ACTOR_TYPE_ORGAN    | 机关     |
| ACTOR_TYPE_BULLET   | 子弹     |
| ACTOR_TYPE_SHENFU   | 神符     |

### ActorTypeSub-Actor子类型
| 类型名                 | 说明           |
|------------------------|----------------|
| ACTOR_SUB_SOLDIER       | 小兵           |
| ACTOR_SUB_TOWER_SPRING  | 泉水塔         |
| ACTOR_SUB_TOWER         | 普通防御塔     |
| ACTOR_SUB_CRYSTAL       | 基地水晶       |
